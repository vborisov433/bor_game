{% extends 'base.html.twig' %}

{% block title %}Game BOR{% endblock %}
{% block time %}
    <time id="picture-time"
          class="timeago"
          datetime="{{ lastPicLongTerm ? lastPicLongTerm.createdAt|date('c') : '' }}">
        {{ lastPicLongTerm ? lastPicLongTerm.createdAt|date('c') : '' }}
    </time>
{% endblock %}

{% block body %}

    <div class="countdown">
{#        <div class="d-flex align-items-center">#}
{#            <strong>Next Hour:</strong> <span id="countdown" class="ms-2 badge bg-info text-white">--:--</span>#}
{#        </div>#}

        <div class="d-flex align-items-center">
            <span id="countdown" class="badge bg-info text-white">--:--:--</span><br>
            <span class="nextTime">Next: <small id="nextTimeLabel" class="text-muted">--:--</small></span>
        </div>

    </div>

    <div id="menuToggle" class="position-fixed">
        <button class="btn btn-primary" id="toggleMenuBtn" type="button">
            <i class="bi bi-caret-left-fill"></i>
        </button>
    </div>

    <div id="menu" style="display: none">
        <div class="mcontent">
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="timeframeDropdown"
                        data-bs-toggle="dropdown" aria-expanded="false">
                    {{ selectedTimeframe }} hour{{ selectedTimeframe > 1 ? 's' : '' }}
                </button>
                <ul class="dropdown-menu" aria-labelledby="timeframeDropdown">
                    {% for h in [1,2,3,4,6,8,10] %}
                        <li>
                            <a class="dropdown-item timeframe-option {% if h == selectedTimeframe %}active{% endif %}"
                               href="#" data-hours="{{ h }}">
                                {{ h }} hour{{ h > 1 ? 's' : '' }}
                            </a>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div id="picture-container" class="text-center">
        {% if lastPicLongTerm %}
            <img id="main-picture"
                 src="{{ asset(lastPicLongTerm.path) }}"
                 class=""
                 alt="Last uploaded picture">
        {% else %}
            <div class="alert alert-info">No pictures uploaded yet.</div>
        {% endif %}
    </div>

    <script>
        $(document).ready(function () {
            const menu = $('#menu');
            const toggleBtn = $('#toggleMenuBtn');
            let selectedHours = parseInt($('.timeframe-option.active').data('hours'));
            const countdownEl = $('#countdown');
            const nextTimeLabel = $('#nextTimeLabel');


            $('.timeframe-option').on('click', function (e) {
                e.preventDefault();
                const hours = $(this).data('hours');

                $('#timeframeDropdown').text(`${hours} hour${hours > 1 ? 's' : ''}`);

                selectedHours = parseInt($(this).data('hours'));

                setTimeout(()=>{
                    toggleBtn.click()
                }, 400);

                $.post("{{ path('app_set_timeframe') }}", {timeframe: hours}, function (response) {
                    if (response.success) {
                        console.log('Timeframe saved:', response.timeframe);
                        // optionally refresh pictures or data
                    }
                });
            });

            toggleBtn.on('click', function () {
                menu.toggle();
                // Change caret direction
                const icon = $(this).find('i');
                icon.toggleClass('bi-caret-left-fill bi-caret-right-fill');
            });

            function updateCountdown() {
                const h = Number(selectedHours) || 2; // ensure number
                const now = new Date();

                // minutes since midnight
                const dayStart = new Date(now);
                dayStart.setHours(0, 0, 0, 0);
                const minutesSinceMidnight = Math.floor((now - dayStart) / 60000);
                const interval = h * 60;

                // next interval start (in minutes from midnight)
                let nextMinutes = Math.floor(minutesSinceMidnight / interval) * interval + interval;

                // build the Date for the next boundary
                const next = new Date(dayStart);
                if (nextMinutes >= 1440) {
                    next.setDate(next.getDate() + Math.floor(nextMinutes / 1440));
                    nextMinutes = nextMinutes % 1440;
                }
                next.setHours(Math.floor(nextMinutes / 60), nextMinutes % 60, 0, 0);

                // diff -> HH:MM:SS
                const diffMs = next - now;
                const totalSeconds = Math.max(0, Math.ceil(diffMs / 1000));
                const hh = Math.floor(totalSeconds / 3600);
                const mm = Math.floor((totalSeconds % 3600) / 60);
                const ss = totalSeconds % 60;

                countdownEl.text(
                    `${String(hh).padStart(1, '0')}:${String(mm).padStart(2, '0')}:${String(ss).padStart(2, '0')}`
                );

                // optional: label exact next time HH:MM
                nextTimeLabel.text(
                    `${String(next.getHours()).padStart(2, '0')}:${String(next.getMinutes()).padStart(2, '0')}`
                );
            }


            updateCountdown();
            setInterval(updateCountdown, 2000);
        });

        $(function () {
            const $img = $("#main-picture");
            const $time = $("#picture-time");

            const lastPicLongTerm = {
                path: "{{ lastPicLongTerm ? asset(lastPicLongTerm.path) : '' }}",
                time: "{{ lastPicLongTerm ? lastPicLongTerm.createdAt|date('c') : '' }}"
            };
            const lastPicRight = {
                path: "{{ lastPicRight ? asset(lastPicRight.path) : '' }}",
                time: "{{ lastPicRight ? lastPicRight.createdAt|date('c') : '' }}"
            };

            function showImage(pic) {
                if (pic.path && $img.attr("src") !== pic.path) {
                    $img.fadeOut(200, function () {
                        $img.attr("src", pic.path).fadeIn(200);
                    });

                    // update datetime attribute
                    $time.attr("datetime", pic.time);

                    // re-render timeago text
                    timeago.cancel(); // clear old timers
                    timeago.render([$time[0]]);
                }
            }

            let touchstartX = 0;
            let touchendX = 0;

            $img.on("touchstart", function (e) {
                touchstartX = e.originalEvent.changedTouches[0].screenX;
            });

            $img.on("touchend", function (e) {
                touchendX = e.originalEvent.changedTouches[0].screenX;
                if (touchendX < touchstartX - 50) {
                    showImage(lastPicLongTerm);
                }
                if (touchendX > touchstartX + 50) {
                    showImage(lastPicRight);
                }
            });

            $(document).on("keydown", function (e) {
                if (e.key === "ArrowLeft") {
                    showImage(lastPicLongTerm);
                } else if (e.key === "ArrowRight") {
                    showImage(lastPicRight);
                }
            });
        });

    </script>
{% endblock %}